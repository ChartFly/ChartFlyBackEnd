<!--
  âœ… ChartFly Admin Panel - Main Template
  Version: v13.5.2 (Flyswatter Edition)
-->

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>ChartFly Admin Panel</title>
    <link rel="icon" href="/static/images/ChartFly-Favicon.ico" />

    <!-- âœ… Styles (Cache-Busted) -->
    <link rel="stylesheet" href="/static/css/styles.css?v=999" />
    <link rel="stylesheet" href="/static/admin/shared/ButtonBox.css?v=999" />
    <link
      rel="stylesheet"
      href="/static/admin/market-holidays/MarketHolidays.css?v=999"
    />
    <link rel="stylesheet" href="/static/admin/api-keys/ApiKeys.css?v=999" />
    <link
      rel="stylesheet"
      href="/static/admin/user-management/UserManagement.css?v=999"
    />
  </head>

  <body>
    <!-- âœ… Header -->
    <div class="admin-header">
      <img src="/static/images/Chartfly-logo.png" class="admin-logo" />
      <h1 class="admin-title">ChartFly Admin Console</h1>
      <div id="market-status-indicator">
        Market Status: <span id="market-status-text">Checking...</span>
      </div>
    </div>

    <!-- ğŸ” Debug Dump -->
    <script>
      window.addEventListener("DOMContentLoaded", () => {
        console.log("ğŸ§¨ DEBUG BLAST â€” DOM Report");
        document
          .querySelectorAll(".admin-tab-section")
          .forEach((section, i) => {
            console.log(
              `ğŸ§± Section ${i + 1}: #${section.id}`,
              section.innerHTML.slice(0, 200)
            );
          });
        console.log(
          "ğŸ“„ Tables found:",
          document.querySelectorAll("table").length
        );
        console.log(
          "ğŸª‘ TBodies found:",
          document.querySelectorAll("tbody").length
        );
        console.log(
          "ğŸ¯ Edit buttons found:",
          document.querySelectorAll("button[id$='edit-btn']").length
        );
        console.log("ğŸ•µï¸â€â™‚ï¸ ButtonBox elements:");
        document.querySelectorAll(".button-box").forEach((b) => {
          console.log(" -", b.id || "(no ID)");
        });
      });
    </script>

    <!-- ğŸ•µï¸ Bonus Debug: ID Scanner -->
    <script>
      window.addEventListener("DOMContentLoaded", () => {
        console.log("ğŸ” ID SCAN â€” All Elements with IDs");
        document.querySelectorAll("[id]").forEach((el) => {
          console.log(`ğŸ§© #${el.id} â€” <${el.tagName.toLowerCase()}>`, el);
        });
      });
    </script>

    <!-- âœ… Tabs -->
    <div class="tab-container">
      <div class="tab" onclick="switchTab('market-holidays-section')">
        Market Holidays
      </div>
      <div class="tab" onclick="switchTab('api-keys-section')">API Keys</div>
      <div class="tab" onclick="switchTab('user-management-section')">
        User Management
      </div>
    </div>

    <!-- âœ… Tab Content -->
    <section
      id="market-holidays-section"
      class="admin-tab-section"
      style="display: none"
    >
      {% include "market-holidays/MarketHolidays.html" %}
    </section>

    <section
      id="api-keys-section"
      class="admin-tab-section"
      style="display: none"
    >
      {% include "api-keys/ApiKeys.html" %}
    </section>

    <section
      id="user-management-section"
      class="admin-tab-section"
      style="display: none"
    >
      {% include "user-management/UserManagement.html" %}
    </section>

    <!-- âœ… Shared Scripts -->
    <script src="/static/admin/shared/ButtonBox.js?v=999"></script>
    <script src="/static/admin/shared/ButtonBoxMessages.js?v=999"></script>
    <script src="/static/admin/shared/ButtonBoxRows.js?v=999"></script>
    <script src="/static/admin/shared/ButtonBoxColumns.js?v=999"></script>

    <!-- âœ… Section Scripts -->
    <script src="/static/frontend/core/main.js?v=999"></script>
    <script src="/static/admin/market-holidays/MarketHolidays.js?v=999"></script>
    <script src="/static/admin/market-holidays/ButtonBoxMarketHolidays.js?v=999"></script>
    <script src="/static/admin/api-keys/ApiKeys.js?v=999"></script>
    <script src="/static/admin/api-keys/ButtonBoxApiKeys.js?v=999"></script>
    <script src="/static/admin/user-management/UserManagement.js?v=999"></script>
    <script src="/static/admin/user-management/ButtonBoxUserManagement.js?v=999"></script>

    <!-- âœ… Footer Ticker -->
    <footer class="admin-footer">
      <div class="footer-ticker">
        <span id="holiday-ticker" class="ticker-content">ğŸ‰ Loading...</span>
        <span
          id="holiday-ticker-duplicate"
          class="ticker-content"
          aria-hidden="true"
          >ğŸ‰ Loading...</span
        >
      </div>
    </footer>

    <!-- âœ… Tab Switcher + Failsafe Loader -->
    <script>
      function switchTab(sectionId) {
        document.querySelectorAll(".admin-tab-section").forEach((section) => {
          section.style.display = section.id === sectionId ? "block" : "none";
        });

        document.querySelectorAll(".tab").forEach((tab) => {
          const isActive = tab.getAttribute("onclick")?.includes(sectionId);
          tab.classList.toggle("active", isActive);
        });

        if (
          sectionId === "market-holidays-section" &&
          !window.MARKET_TAB_LOADED
        ) {
          window.MARKET_TAB_LOADED = true;
          loadMarketHolidays();
        }

        if (sectionId === "api-keys-section" && !window.API_TAB_LOADED) {
          window.API_TAB_LOADED = true;
          loadApiKeys();
        }

        if (
          sectionId === "user-management-section" &&
          !window.USER_TAB_LOADED
        ) {
          window.USER_TAB_LOADED = true;
          loadAdminUsers();
        }
      }

      window.addEventListener("load", () => {
        console.log(
          "ğŸ§¼ Full window loaded. Checking if loadMarketHolidays exists..."
        );

        let attempts = 0;
        const maxAttempts = 50;

        const interval = setInterval(() => {
          if (typeof loadMarketHolidays === "function") {
            console.log("âœ… loadMarketHolidays is now available.");
            clearInterval(interval);
            switchTab("market-holidays-section");
          } else {
            if (++attempts > maxAttempts) {
              console.warn(
                "â›” Gave up waiting for loadMarketHolidays after 50 tries."
              );
              clearInterval(interval);
            } else {
              console.log("â³ Waiting for loadMarketHolidays...");
            }
          }
        }, 100);
      });
    </script>
  </body>
</html>
